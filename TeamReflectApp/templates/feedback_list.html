{% extends "base.html" %}

{% block title %}Feedback list{% endblock %}

{% block content %}

<button id="toggleCharts" onclick="toggleCharts()">üìä Poka≈º/Ukryj Wykresy</button>
<button id="toggleChartType" data-type="bar" style="display: none;">üîÑ Zmie≈Ñ wykres</button>

<div id="chartsContainer" style="display: none;">

    {% if data_target %}
        <h3> Wed≈Çug Typu</h3>
        <canvas id="feedbackTypeChart" style="max-width: 600px; max-height: 400px;"></canvas>
    {% endif %}

    {% if data_priority %}
        <h3> Wed≈Çug Priorytetu</h3>
        <canvas id="feedbackPriorityChart" style="max-width: 600px; max-height: 400px;"></canvas>
    {% endif %}

</div> <!-- Koniec div chartsContainer -->

<ul id="feedback-list">
    {% for feedback in feedbacks %}
        <li class="feedback-item">
            <div class="feedback-header">
                <a href="/feedback/{{ feedback.id_feedback }}">
                    <b class="feedback-title">{{ feedback.title }}</b>
                </a>
                <span class="feedback-meta">
                    Stworzony: {{ feedback.created_at }} | 
                    Priorytet: {{ feedback.priority }} | 
                    {% if feedback.for_post %}  {% comment %} Post > User > Group, TODO, properly make these fields exclusive so this doesn't need to be a thing {% endcomment %}
                        Do postu: 
                        <a href="/post/{{ feedback.for_post.id_post }}">
                            {{ feedback.for_post }}
                        </a> |
                    {% elif feedback.for_user %}
                        Dla u≈ºytkownika: 
                        <a href="/profile/{{ feedback.for_user }}">
                            {{ feedback.for_user }}
                        </a> |
                    {% elif feedback.for_group %}
                        Dla grupy: 
                        <a href="/groups/{{ feedback.for_group.id_group }}">
                            {{ feedback.for_group }}
                        </a> |
                    {% endif %}
                </span>
            </div>
            <div class="feedback-body">
                <p><b>Poster:</b> {{ feedback.created_by }}</p>
                <p class="text-container">{{ feedback.content }}</p>
            </div>
            <div class="feedback-footer">
                <span><b>Ocena:</b> {{ feedback.rating }}/5</span>
                <span><b>üëç:</b> {{ feedback.likes }}</span>
            </div>
        </li>
    {% endfor %}
</ul>

    <!-- Dodanie Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const dataTarget = JSON.parse('{{ data_target|safe }}');
        const dataPriority = JSON.parse('{{ data_priority|safe }}');

        const labelsTarget = Object.keys(dataTarget);
        const valuesTarget = Object.values(dataTarget);

        const labelsPriority = Object.keys(dataPriority);
        const valuesPriority = Object.values(dataPriority);

        let feedbackTypeChart, feedbackPriorityChart;
        let currentChartType = "bar"; // Domy≈õlnie wykres s≈Çupkowy

        function getPriorityColors() {
            return labelsPriority.map(label => {
                if (label.toLowerCase().includes("niski")) return "blue";
                if (label.toLowerCase().includes("≈õredni")) return "green";
                if (label.toLowerCase().includes("wysoki")) return "red";             
            });
        }

        function getPercentageData(values) {
            const total = values.reduce((sum, value) => sum + value, 0);
            return values.map(value => ((value / total) * 100).toFixed(1)); 
        }

        function createCharts(chartType) {
            
            if (feedbackTypeChart) feedbackTypeChart.destroy();
            if (feedbackPriorityChart) feedbackPriorityChart.destroy();

           
            const colorBar = "navy"; 
            const colorsPiePriority = getPriorityColors(); // Dynamiczne kolory dla priorytet√≥w w ko≈Çowym

            
            const percentagePriority = getPercentageData(valuesPriority);
            const percentageTarget = getPercentageData(valuesTarget);

            const displayDataTarget = chartType === "pie" ? percentageTarget : valuesTarget;
            const displayDataPriority = chartType === "pie" ? percentagePriority : valuesPriority;

           
            feedbackTypeChart = new Chart(document.getElementById("feedbackTypeChart"), {
                type: chartType,
                data: {
                    labels: labelsTarget,
                    datasets: [{
                        label: "≈örednia ocena",
                        data: displayDataTarget,
                        backgroundColor: chartType === "bar" ? colorBar : ["red", "blue", "green"]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { display: chartType === "pie" },
                        tooltip: { 
                            callbacks: {
                                label: function(tooltipItem) {
                                    const originalValue = valuesTarget[tooltipItem.dataIndex]; // Pobiera ≈õredniƒÖ ocenƒô
                                    return `${tooltipItem.label}: ${originalValue.toFixed(1)}`;
                                }
                            }
                        },
                        datalabels: chartType === "pie" ? { 
                            color: "white",
                            font: { weight: "bold", size: 14 },
                            formatter: (value) => `${value}%`
                        } : false
                    }
                },
                plugins: chartType === "pie" ? [ChartDataLabels] : []
            });

          
            feedbackPriorityChart = new Chart(document.getElementById("feedbackPriorityChart"), {
                type: chartType,
                data: {
                    labels: labelsPriority,
                    datasets: [{
                        label: "≈örednia ocena",
                        data: displayDataPriority,
                        backgroundColor: chartType === "bar" ? colorBar : colorsPiePriority
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { display: chartType === "pie" },
                        tooltip: { 
                            callbacks: {
                                label: function(tooltipItem) {
                                    const originalValue = valuesPriority[tooltipItem.dataIndex]; // Pobiera ≈õredniƒÖ ocenƒô
                                    return `${tooltipItem.label}: ${originalValue.toFixed(1)}`;
                                }
                            }
                        },
                        datalabels: chartType === "pie" ? { 
                            color: "white",
                            font: { weight: "bold", size: 14 },
                            formatter: (value) => `${value}%`
                        } : false
                    }
                },
                plugins: chartType === "pie" ? [ChartDataLabels] : []
            });
        }

       
        function toggleChartType() {
            currentChartType = currentChartType === "bar" ? "pie" : "bar";
            createCharts(currentChartType);

            
            document.getElementById("toggleChartType").textContent =
                currentChartType === "bar" ? "üîÑ Zmie≈Ñ na wykres ko≈Çowy" : "üîÑ Zmie≈Ñ na wykres s≈Çupkowy";
        }

        function toggleCharts() {
            var container = document.getElementById("chartsContainer");
            var toggleChartTypeButton = document.getElementById("toggleChartType");

            if (container.style.display === "none") {
                container.style.display = "block";
                toggleChartTypeButton.style.display = "inline-block"; 
                createCharts("bar"); 

                
                currentChartType = "bar";
                toggleChartTypeButton.textContent = "üîÑ Zmie≈Ñ na wykres ko≈Çowy";
            } else {
                container.style.display = "none";
                toggleChartTypeButton.style.display = "none"; 
            }
        }

        
        document.getElementById("toggleChartType").addEventListener("click", toggleChartType);
        document.getElementById("toggleCharts").addEventListener("click", toggleCharts);
    });
</script>

{% endblock %}